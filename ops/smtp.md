# בויען דיין אייגענע סמטפּ פּאָסט שיקט סערווער

## הקדמה

SMTP קענען גלייַך קויפן באַדינונגס פון וואָלקן ווענדאָרס, אַזאַ ווי:

* [אַמאַזאָן סעס סמטפּ](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [עלי וואָלקן email שטופּן](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

איר קענען אויך בויען דיין אייגענע פּאָסט סערווער - אַנלימאַטאַד שיקט, נידעריק קוילעלדיק פּרייַז.

ונטער, מיר באַווייַזן שריט דורך שריט ווי צו בויען אונדזער אייגענע פּאָסט סערווער.

## סערווירער סעלעקציע

די זיך-כאָוסטיד SMTP סערווער ריקווייערז אַ עפנטלעך IP מיט פּאָרץ 25, 456 און 587 אָופּאַנד.

קאַמאַנלי געוויינט ציבור וואלקנס האָבן אפגעשטעלט די פּאָרץ דורך פעליקייַט, און עס קען זיין מעגלעך צו עפֿענען זיי דורך אַרויסגעבן אַ אַרבעט סדר, אָבער דאָס איז נאָך זייער טראַבאַלסאַם.

איך רעקאָמענדירן בייינג פון אַ באַלעבאָס וואָס האט די פּאָרץ אָופּאַנד און שטיצט באַשטעטיקן אַרויף פאַרקערט פעלד נעמען.

דאָ, איך רעקאָמענדירן [קאָנטאַבאָ](https://contabo.com) .

קאָנטאַבאָ איז אַ האָסטינג שפּייַזער באזירט אין מוניטש, דייַטשלאַנד, געגרינדעט אין 2003 מיט זייער קאַמפּעטיטיוו פּרייסאַז.

אויב איר קלייַבן ייראָ ווי די קויפן קראַנטקייַט, די פּרייַז וועט זיין טשיפּער (אַ סערווער מיט 8 גיגאבייט זכּרון און 4 קפּוס קאָס וועגן 529 יואַן פּער יאָר, און די ערשט ינסטאַלירונג אָפּצאָל איז פריי פֿאַר איין יאָר).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

ווען פּלייסינג אַ סדר, באַמערקונג `prefer AMD` , און דער סערווער מיט אַמד קפּו וועט האָבן בעסער פאָרשטעלונג.

אין די פאלגענדע, איך וועל נעמען Contabo's VPS ווי אַ ביישפּיל צו באַווייַזן ווי צו בויען דיין אייגענע פּאָסט סערווער.

## Ubuntu סיסטעם קאַנפיגיעריישאַן

די אָפּערייטינג סיסטעם דאָ איז Ubuntu 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

אויב דער סערווער אויף ssh דיספּלייז `Welcome to TinyCore 13!` (ווי געוויזן אין די פיגור אונטן), עס מיטל אַז די סיסטעם איז נישט אינסטאַלירן נאָך. ביטע דיסקאַנעקט ssh און וואַרטן פֿאַר אַ ביסל מינוט צו קלאָץ אין ווידער.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

ווען `Welcome to Ubuntu 22.04.1 LTS` איז ארויס, די יניטיאַליזיישאַן איז גאַנץ, און איר קענען פאָרזעצן מיט די פאלגענדע סטעפּס.

### [אָפּטיאָנאַל] ינישאַליזע די אַנטוויקלונג סוויווע

דעם שריט איז אַפּשאַנאַל.

פֿאַר קאַנוויניאַנס, איך שטעלן די ינסטאַלירונג און סיסטעם קאַנפיגיעריישאַן פון ובונטו ווייכווארג אין [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) .

לויפן די פאלגענדע באַפֿעל צו ינסטאַלירן מיט איין גיט.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

כינעזיש יוזערז, ביטע נוצן די פאלגענדע באַפֿעל אַנשטאָט, און די שפּראַך, צייט זאָנע, אאז"ו ו וועט זיין אויטאָמאַטיש באַשטימט.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### קאָנטאַבאָ ינייבאַלז IPV6

געבן IPV6 אַזוי אַז SMTP קענען אויך שיקן ימיילז מיט IPV6 אַדרעסעס.

רעדאַגירן `/etc/sysctl.conf`

מאָדיפיצירן אָדער לייגן די פאלגענדע שורות

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

גיי אַרויף מיט [די קאַנטאַבאָ טוטאָריאַל: אַדינג IPv6 קאַנעקטיוויטי צו דיין סערווער](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

רעדאַגירן `/etc/netplan/01-netcfg.yaml` , לייגן אַ ביסל שורות ווי געוויזן אין די פיגור אונטן (Contabo VPS פעליקייַט קאַנפיגיעריישאַן טעקע האט שוין די שורות, נאָר נעם אַוועק זיי).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

דערנאָך `netplan apply` צו מאַכן די מאַדאַפייד קאַנפיגיעריישאַן נעמען ווירקונג.

נאָך די קאַנפיגיעריישאַן איז געראָטן, איר קענען נוצן `curl 6.ipw.cn` צו זען די יפּוו6 אַדרעס פון דיין פונדרויסנדיק נעץ.

## קלאָון די קאַנפיגיעריישאַן ריפּאַזאַטאָרי אָפּס

```
git clone https://github.com/wactax/ops.soft.git
```

## דזשענערייט אַ פריי SSL באַווייַזן פֿאַר דיין פעלד נאָמען

שיקט פּאָסט ריקווייערז אַ SSL באַווייַזן פֿאַר ענקריפּשאַן און סיינינג.

מיר נוצן [acme.sh](https://github.com/acmesh-official/acme.sh) צו דזשענערייט סערטיפיקאַץ.

acme.sh איז אַן אָפֿן מקור אָטאַמייטיד באַווייַזן סיינינג געצייַג,

אַרייַן די קאַנפיגיעריישאַן ווערכאַוס ops.soft, לויפן `./ssl.sh` , און אַ `conf` טעקע וועט זיין באשאפן אין **דער אויבערשטער וועגווייַזער** .

געפֿינען דיין דנס שפּייַזער פֿון [acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) , רעדאַגירן `conf/conf.sh` .

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

דערנאָך לויפן `./ssl.sh 123.com` צו דזשענערייט `123.com` און `*.123.com` סערטיפיקאַץ פֿאַר דיין פעלד נאָמען.

דער ערשטער לויפן וועט אויטאָמאַטיש ינסטאַלירן [acme.sh](https://github.com/acmesh-official/acme.sh) און לייגן אַ סקעדזשולד אַרבעט פֿאַר אָטאַמאַטיק רינואַל. איר קענען זען `crontab -l` , עס איז אַזאַ אַ שורה ווי גייט.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

דער דרך פֿאַר די דזשענערייטאַד באַווייַזן איז עפּעס ווי `/mnt/www/.acme.sh/123.com_ecc。`

סערטיפיקאַט רינואַל וועט רופן `conf/reload/123.com.sh` שריפט, רעדאַגירן דעם שריפט, איר קענען לייגן קאַמאַנדז אַזאַ ווי `nginx -s reload` צו דערפרישן די באַווייַזן קאַש פון פֿאַרבונדענע אַפּלאַקיישאַנז.

## בויען סמטפּ סערווער מיט טשאַסקוויד

[chasquid](https://github.com/albertito/chasquid) איז אַן אָפֿן מקור סמטפּ סערווער געשריבן אין גיין שפּראַך.

ווי אַ פאַרטרעטער פֿאַר די אלטע פּאָסט סערווער מגילה אַזאַ ווי Postfix און Sendmail, טשאַסקוויד איז סימפּלער און גרינגער צו נוצן, און עס איז אויך גרינגער פֿאַר צווייטיק אַנטוויקלונג.

לויפן `./chasquid/init.sh 123.com` וועט זיין אינסטאַלירן אויטאָמאַטיש מיט איין גיט (פאַרבייַטן 123.com מיט דיין שיקט פעלד נאָמען).

## קאַנפיגיער Email סיגנאַטורע DKIM

DKIM איז גענוצט צו שיקן E- בריוו סיגנאַטשערז צו פאַרמייַדן אותיות פון זיין באהאנדלט ווי ספּאַם.

נאָך די באַפֿעל לויפט הצלחה, איר וועט זיין פּראַמפּטיד צו שטעלן די DKIM רעקאָרד (ווי געוויזן אונטן).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

נאָר לייגן אַ טקסט רעקאָרד צו דיין דנס (ווי געוויזן אונטן).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## זען סערוויס סטאַטוס און לאָגס

 `systemctl status chasquid` View סערוויס סטאַטוס.

דער שטאַט פון נאָרמאַל אָפּעראַציע איז ווי געוויזן אין די פיגור אונטן

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` אָדער `journalctl -xeu chasquid` קענען זען די טעות קלאָץ.

## פאַרקערט פעלד נאָמען קאַנפיגיעריישאַן

דער פאַרקערט פעלד נאָמען איז צו לאָזן די IP אַדרעס צו זיין ריזאַלווד צו די קאָראַספּאַנדינג פעלד נאָמען.

באַשטעטיקן אַ פאַרקערט פעלד נאָמען קענען פאַרמייַדן ימיילז פון זייַענדיק יידענאַפייד ווי ספּאַם.

ווען די פּאָסט איז באקומען, די ריסיווינג סערווער וועט דורכפירן פאַרקערט פעלד נאָמען אַנאַליסיס אויף די IP אַדרעס פון די שיקט סערווער צו באַשטעטיקן צי די שיקט סערווער האט אַ גילטיק פאַרקערט פעלד נאָמען.

אויב די שיקט סערווער האט נישט אַ פאַרקערט פעלד נאָמען אָדער אויב די פאַרקערט פעלד נאָמען איז נישט גלייַכן די IP אַדרעס פון די שיקט סערווער, דער ריסיווינג סערווער קען דערקענען די E- בריוו ווי ספּאַם אָדער אָפּוואַרפן עס.

באַזוכן [https://my.contabo.com/rdns](https://my.contabo.com/rdns) און קאַנפיגיער ווי געוויזן אונטן

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

נאָך באַשטעטיקן די פאַרקערט פעלד נאָמען, געדענקען צו קאַנפיגיער די פאָרויס האַכלאָטע פון ​​די פעלד נאָמען יפּוו4 און יפּוו6 צו די סערווער.

## רעדאַגירן די האָסטנאַמע פון ​​chasquid.conf

מאָדיפיצירן `conf/chasquid/chasquid.conf` צו די ווערט פון די פאַרקערט פעלד נאָמען.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

דערנאָך לויפן `systemctl restart chasquid` צו ריסטאַרט די דינסט.

## באַקקופּ קאָנף צו גיט ריפּאַזאַטאָרי

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

פֿאַר בייַשפּיל, איך באַקאַפּ די קאָנף טעקע צו מיין אייגענע גיטהוב פּראָצעס ווי גייט

שאַפֿן אַ פּריוואַט ווערכאַוס ערשטער

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

אַרייַן די קאָנף וועגווייַזער און פאָרלייגן צו די ווערכאַוס

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## לייג סענדער

לויפן

```
chasquid-util user-add i@wac.tax
```

קענען לייגן סענדער

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### באַשטעטיקן אַז די פּאַראָל איז ריכטיק באַשטימט

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

נאָך אַדינג דעם באַניצער, `chasquid/domains/wac.tax/users` וועט זיין דערהייַנטיקט, געדענקט צו פאָרלייגן עס צו די ווערכאַוס.

## דנס לייגן ספּף רעקאָרד

SPF (Sender Policy Framework) איז אַן E- בריוו וועראַפאַקיישאַן טעכנאָלאָגיע געניצט צו פאַרמייַדן E- בריוו שווינדל.

עס וועראַפייז די אידענטיטעט פון אַ פּאָסט סענדער דורך קאָנטראָלירונג אַז די סענדער ס IP אַדרעס גלייַכן די דנס רעקאָרדס פון די פעלד נאָמען עס קליימז צו זיין, פּרעווענטינג פראָדסטערז פון שיקן פאַלש ימיילז.

אַדינג ספּף רעקאָרדס קענען פאַרמייַדן ימיילז פון זייַענדיק יידענאַפייד ווי ספּאַם ווי פיל ווי מעגלעך.

אויב דיין פעלד נאָמען סערווער שטיצט נישט SPF טיפּ, נאָר לייגן טקסט טיפּ רעקאָרד.

פֿאַר בייַשפּיל, די SPF פון `wac.tax` איז ווי גייט

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

ספּף פֿאַר `_spf.wac.tax`

`v=spf1 a:smtp.wac.tax ~all`

באַמערקונג אַז איך האָבן `include:_spf.google.com` דאָ, דאָס איז ווייַל איך וועל קאַנפיגיער `i@wac.tax` ווי די שיקט אַדרעס אין די Google בריווקאַסטן שפּעטער.

## דנס קאַנפיגיעריישאַן DMARC

DMARC איז די אַבריווייישאַן פון (Domain-based Message Authentication, Reporting & Conformance).

עס איז געניצט צו כאַפּן ספּף באַונסיז (אפֿשר געפֿירט דורך קאַנפיגיעריישאַן ערראָרס, אָדער עמעצער אַנדערש איז פּריטענדינג איר צו שיקן ספּאַם).

לייג טקסט רעקאָרד `_dmarc` ,

דער אינהאַלט איז ווי גייט

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

דער טייַטש פון יעדער פּאַראַמעטער איז ווי גייט

### פּ (פּאָליטיק)

ינדיקייץ ווי צו שעפּן ימיילז וואָס פאַרלאָזן SPF (סענדער פּאָליטיק פראַמעוואָרק) אָדער DKIM (DomainKeys Identified Mail) וועראַפאַקיישאַן. די פּ פּאַראַמעטער קענען זיין שטעלן צו איינער פון דרייַ וואַלועס:

* גאָרניט: קיין קאַמף איז גענומען, בלויז די וועראַפאַקיישאַן רעזולטאַט איז פעד צוריק צו די סענדער דורך די E- בריוו רעפּאָרטינג מעקאַניזאַם.
* קאַראַנטין: שטעלן די פּאָסט וואָס איז נישט דורכגעגאנגען די וועראַפאַקיישאַן אין די ספּאַם טעקע, אָבער וועט נישט אָפּוואַרפן די פּאָסט גלייַך.
* אָפּוואַרפן: גלייך אָפּוואַרפן ימיילז וואָס דורכפאַל וועראַפאַקיישאַן.

### fo (פעלן אָפּציעס)

ספּעציפיצירט די סומע פון ​​אינפֿאָרמאַציע אומגעקערט דורך די ריפּאָרטינג מעקאַניזאַם. עס קענען זיין באַשטימט צו איינער פון די פאלגענדע וואַלועס:

* 0: באריכט וואַלאַדיישאַן רעזולטאַטן פֿאַר אַלע אַרטיקלען
* 1: בלויז באַריכט אַרטיקלען וואָס פאַרלאָזן וועראַפאַקיישאַן
* ד: בלויז באַריכט פעלד נאָמען וועראַפאַקיישאַן פייליערז
* s: בלויז באַריכט ספּף וועראַפאַקיישאַן פייליערז
* l: בלויז באַריכט DKIM וועראַפאַקיישאַן פייליערז

### rua & ruf

* rua (ריפּאָרטינג URI פֿאַר אַגגרעגאַטע ריפּאָרץ): בליצפּאָסט אַדרעס פֿאַר ריסיווינג אַגגרעגאַטעד ריפּאָרץ
* ruf (ריפּאָרטינג URI פֿאַר פאָרענסיק ריפּאָרץ): בליצפּאָסט אַדרעס צו באַקומען דיטיילד ריפּאָרץ

## לייג מקס רעקאָרדס צו פֿאָרווערטס ימיילז צו Google מעיל

ווייַל איך קען נישט געפֿינען אַ פריי פֿירמע בריווקאַסטן וואָס שטיצט וניווערסאַל אַדרעסעס (Catch-All, קענען באַקומען קיין E- בריוו געשיקט צו דעם פעלד נאָמען, אָן ריסטריקשאַנז אויף פּרעפיקס), איך געוויינט טשאַסקוויד צו פאָרווערדיד אַלע ימיילז צו מיין Gmail בריווקאַסטן.

**אויב איר האָט דיין אייגענע באַצאָלט געשעפט בריווקאַסטן, ביטע טאָן ניט מאָדיפיצירן די MX און האָפּקען דעם שריט.**

רעדאַגירן `conf/chasquid/domains/wac.tax/aliases` , שטעלן פאָרווערדינג בריווקאַסטן

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` ינדיקייץ אַלע ימיילז, `i` איז די פּרעפיקס פון די שיקט באַניצער באשאפן אויבן. צו פֿאָרווערטס פּאָסט, יעדער באַניצער דאַרף צוגעבן אַ שורה.

דערנאָך לייגן די מקס רעקאָרד (איך פונט גלייך צו די אַדרעס פון די פאַרקערט פעלד נאָמען דאָ, ווי געוויזן אין דער ערשטער שורה אין די פיגור אונטן).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

נאָך די קאַנפיגיעריישאַן איז גאַנץ, איר קענען נוצן אנדערע בליצפּאָסט אַדרעסעס צו שיקן E- בריוו צו `i@wac.tax` און `any123@wac.tax` צו זען אויב איר קענען באַקומען ימיילז אין Gmail.

אויב ניט, קאָנטראָלירן די טשאַסקוויד קלאָץ ( `grep chasquid /var/log/syslog` ).

## שיקן אַן E- בריוו צו i@wac.tax מיט Google מעיל

נאָך Google Mail באקומען די פּאָסט, איך געוויינטלעך געהאפט צו ענטפֿערן מיט `i@wac.tax` אַנשטאָט פון i.wac.tax@gmail.com.

באַזוכן [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) און גיט "לייג אן אנדער בליצפּאָסט אַדרעס".

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

דערנאָך אַרייַן די וועראַפאַקיישאַן קאָד באקומען דורך די E- בריוו וואָס איז געווען פאָרווערדיד צו.

צום סוף, עס קענען זיין באַשטימט ווי די פעליקייַט סענדער אַדרעס (צוזאמען מיט די אָפּציע צו ענטפֿערן מיט דער זעלביקער אַדרעס).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

אין דעם וועג, מיר האָבן געענדיקט די פאַרלייגן פון די SMTP פּאָסט סערווער און אין דער זעלביקער צייט נוצן Google Mail צו שיקן און באַקומען ימיילז.

## שיקן אַ פּראָבע E- בריוו צו קאָנטראָלירן צי די קאַנפיגיעריישאַן איז געראָטן

אַרייַן `ops/chasquid`

לויפן `direnv allow` צו ינסטאַלירן דיפּענדאַנסיז (דירענוו איז אינסטאַלירן אין די פריערדיקע איין-שליסל יניטיאַליזאַטיאָן פּראָצעס און אַ קרוק איז צוגעלייגט צו די שאָל)

דעמאָלט לויפן

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

דער טייַטש פון די פּאַראַמעטערס איז ווי גייט

* באַניצער: סמטפּ נאמען
* פאָרן: סמטפּ פּאַראָל
* צו: באַקומער

איר קענען שיקן אַ פּרובירן E- בריוו.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

עס איז רעקאַמענדיד צו נוצן Gmail צו באַקומען פּראָבע ימיילז צו קאָנטראָלירן צי די קאַנפיגיעריישאַנז זענען געראָטן.

### TLS נאָרמאַל ענקריפּשאַן

ווי געוויזן אין די פיגור אונטן, עס איז דעם קליין שלאָס, וואָס מיטל אַז די SSL באַווייַזן איז הצלחה ענייבאַלד.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

דעמאָלט גיט "ווייַזן אָריגינעל בליצפּאָסט"

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

ווי געוויזן אין די פיגור אונטן, די Gmail אָריגינעל פּאָסט בלאַט דיספּלייז DKIM, וואָס מיטל אַז די DKIM קאַנפיגיעריישאַן איז געראָטן.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

קוק די באקומען אין די כעדער פון דער אָריגינעל בליצפּאָסט, און איר קענען זען אַז די סענדער אַדרעס איז IPV6, וואָס מיטל אַז IPV6 איז אויך קאַנפיגיערד הצלחה.
